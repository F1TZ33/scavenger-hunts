<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scavenger Hunts</title>

<style>
:root{
  --bg:#f4f6f8;
  --card:#ffffff;
  --accent:#2563eb;
  --text:#111827;
}
body{
  margin:0;
  font-family: system-ui,-apple-system,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.theme-blue{--accent:#2563eb;}
.theme-red{--accent:#dc2626;}
.theme-green{--accent:#16a34a;}
.theme-purple{--accent:#7c3aed;}
.theme-dark{--bg:#0f172a;--card:#020617;--text:#e5e7eb;--accent:#38bdf8;}

.card{max-width:900px;margin:auto;padding:20px;}
.hunt{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid #ddd;}
button{padding:10px 16px;border-radius:10px;border:none;background:var(--accent);color:white;font-size:16px;cursor:pointer;}
button.secondary{background:#6b7280;}
textarea,input,select{width:100%;padding:10px;margin-bottom:10px;font-size:16px;}
.center-screen{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;}
.center-screen h1{font-size:2.2rem;}
.center-screen p{font-size:1.5rem;max-width:800px;}
.bottom-bar{position:fixed;bottom:0;left:0;right:0;padding:16px;display:flex;justify-content:center;gap:12px;}
video{width:100%;max-width:420px;border-radius:12px;margin-top:12px;}
.admin{border:2px dashed #dc2626;}
</style>
</head>

<body>
<div class="card" id="app"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
/* ========= UTIL ========= */
function cleanText(t){return t.replace(/[‚Äò‚Äô]/g,"'").replace(/[‚Äú‚Äù]/g,'"');}
function uid(){return Math.random().toString(36).slice(2,9);}

/* ========= ADMIN ========= */
let isAdmin = localStorage.getItem("admin")==="1";
function toggleAdmin(){
  isAdmin=!isAdmin;
  localStorage.setItem("admin",isAdmin?"1":"0");
  home();
}

/* ========= DEFAULT HUNTS ========= */
const DEFAULT_HUNTS={
  escape:{name:"Escape the House",theme:"blue",intro:"Welcome! Your escape challenge begins now üè†",clues:["I show your face but I'm not a photo.","I have pages but no homework.","I keep food safe and cold.","I go round and round but never get dizzy.","I have hands but no arms.","I hide your feet when you're not home.","I'm soft, comfy, and steal naps.","I light the dark when switched on.","I'm full of secrets behind closed doors.","The prize is hidden where valuables stay safe."],finish:"üéâ Congratulations! You escaped the house!"},
  fortnite:{name:"Fortnite IRL",theme:"purple",intro:"Drop in! Your real-world Fortnite challenge starts now üéÆ",clues:["Controllers land here after a match.","Drinks restore shields here.","Shoes hide here after the storm.","Materials are stored with tools.","The squad gathers here.","You can‚Äôt win without sleep.","Secrets behind closed doors.","Devices recharge here.","High ground advantage.","Where battles are watched.","Snacks disappear here.","Victory Royale location."],finish:"üèÜ Victory Royale! You completed the hunt!"},
  hacker:{name:"System Breach",theme:"dark",intro:"‚ö†Ô∏è Incoming transmission‚Ä¶ system access required.",clues:["Device that controls all others.","Passwords written but not digital.","Cold data storage.","Where commands are typed.","Single click changes everything.","Primary power source.","Clothes reset location.","Backup storage area.","Display output surface.","Permission checkpoint.","Hidden encrypted space.","Logs of activity.","User rest zone.","Final access node.","Root access payload location."],finish:"‚úÖ SYSTEM BREACH COMPLETE ‚Äî ACCESS GRANTED."}
};

let userHunts=JSON.parse(localStorage.getItem("userHunts")||"{}");
let HUNTS={...DEFAULT_HUNTS,...userHunts};
function save(){localStorage.setItem("userHunts",JSON.stringify(userHunts));}

/* ========= ROUTER ========= */
const q=new URLSearchParams(location.search);
const app=document.getElementById("app");

if(q.get("play")) play();
else if(q.get("edit")) createHunt(q.get("edit"));
else if(q.get("new")) createHunt();
else home();

/* ========= HOME ========= */
function home(){
  app.className="";
  app.innerHTML=`
    <h1>QR Scavenger Hunts</h1>
    <button onclick="location='?new=1'">‚ûï Create New Hunt</button>
    <button class="secondary" onclick="toggleAdmin()">
      ${isAdmin?"üîì Exit Admin":"üîí Admin"}
    </button>
    ${Object.entries(HUNTS)
      .sort((a,b)=>a[1].name.localeCompare(b[1].name))
      .map(([k,h])=>`
        <div class="hunt ${isAdmin && !DEFAULT_HUNTS[k]?'admin':''}">
          <h3>${h.name}</h3>
          <button onclick="generatePDF('${k}')">üñ® Generate QR PDF</button>
          ${!DEFAULT_HUNTS[k]?`<button class="secondary" onclick="location='?edit=${k}'">‚úè Modify</button>`:""}
          ${isAdmin && !DEFAULT_HUNTS[k]?`<button style="background:#dc2626" onclick="deleteHunt('${k}')">üóë Delete</button>`:""}
        </div>
      `).join("")}
  `;
}

function deleteHunt(k){
  if(confirm("Delete this hunt permanently?")){
    delete userHunts[k];
    delete HUNTS[k];
    save();
    home();
  }
}

/* ========= CREATE / EDIT ========= */
function createHunt(k){
  const h=k?HUNTS[k]:{name:"",theme:"blue",intro:"",clues:[""],finish:""};
  app.innerHTML=`
    <h2>${k?"Modify":"Create"} Hunt</h2>
    <input id="name" placeholder="Hunt name" value="${h.name}">
    <select id="theme">${["blue","red","green","purple","dark"].map(t=>`<option ${h.theme===t?"selected":""}>${t}</option>`).join("")}</select>
    <textarea id="intro" placeholder="Custom intro message">${h.intro}</textarea>
    <div id="clues"></div>
    <button onclick="addClue()">‚ûï Add Clue</button>
    <textarea id="finish" placeholder="Final congratulations message">${h.finish}</textarea>
    <button onclick="saveHunt('${k||""}')">üíæ Save</button>
    <button class="secondary" onclick="home()">Cancel</button>
  `;
  h.clues.forEach(c=>addClue(c));
}

function addClue(text=""){
  const t=document.createElement("textarea");
  t.placeholder="Clue text";
  t.value=text;
  document.getElementById("clues").appendChild(t);
}

function saveHunt(k){
  const name=document.getElementById("name").value.trim();
  const intro=document.getElementById("intro").value.trim();
  const finish=document.getElementById("finish").value.trim();
  const theme=document.querySelector("select").value;
  const clues=[...document.querySelectorAll("#clues textarea")].map(t=>t.value).filter(Boolean);
  if(!name||!intro||!finish||!clues.length) return alert("All fields required");
  if(!k) k=uid();
  userHunts[k]={name,theme,intro,clues,finish};
  HUNTS[k]=userHunts[k];
  save();
  home();
}

/* ========= PLAY ========= */
function play(){
  const key=q.get("play");
  const h=HUNTS[key];
  const step=parseInt(q.get("s"));
  document.body.className="theme-"+h.theme;
  const store="p-"+key;
  let p=parseInt(localStorage.getItem(store)||"-1");

  const show=(title,text)=>{
    app.innerHTML=`
      <div class="center-screen">
        <h1>${title}</h1><p>${text}</p>
      </div>
      <div class="bottom-bar"><button onclick="startCamera()">üì∑ Scan QR</button></div>
      <video id="video" hidden></video>`;
  };

  if(step===0 && p===-1){localStorage.setItem(store,0);return show("üéÅ Invitation","You have been invited to complete a treasure hunt.");}
  if(step===1 && p===0){localStorage.setItem(store,1);return show("üéâ Message",h.intro);}

  if(step===p+1){
    localStorage.setItem(store,step);
    const i=step-2;
    if(i>=0 && i<h.clues.length) return show(`Clue ${i+1}`,h.clues[i]);
    if(step===h.clues.length+2){localStorage.removeItem(store);return show("üéâ Finished!",h.finish);}
  }

  app.innerHTML=`
    <div class="center-screen"><h1>‚ùå Wrong QR</h1><p>That code is not correct.</p></div>
    <div class="bottom-bar"><button class="secondary" onclick="location='?play=${key}&s=${p}'">‚¨Ö Back</button></div>`;
}

/* ========= CAMERA ========= */
async function startCamera(){
  const v=document.getElementById("video");
  v.hidden=false;
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  v.srcObject=s;v.play();
  const c=document.createElement("canvas"),x=c.getContext("2d");
  (function scan(){
    if(v.readyState===v.HAVE_ENOUGH_DATA){
      c.width=v.videoWidth;c.height=v.videoHeight;
      x.drawImage(v,0,0);
      const d=x.getImageData(0,0,c.width,c.height);
      const qr=jsQR(d.data,c.width,c.height);
      if(qr){location.href=qr.data;return;}
    }
    requestAnimationFrame(scan);
  })();
}

/* ========= PDF ========= */
async function generatePDF(k){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  const h=HUNTS[k];
  const base=location.origin+location.pathname;

  async function page(title,url){
    pdf.addPage();
    pdf.text(title,10,20);
    const c=document.createElement("canvas");
    await QRCode.toCanvas(c,url,{width:300});
    pdf.addImage(c.toDataURL(),"PNG",30,40,150,150);
  }

  pdf.text(h.name,10,20);
  pdf.text("Print and place these QR codes in order.",10,30);

  await page("START QR",`${base}?play=${k}&s=0`);
  await page("INTRO QR",`${base}?play=${k}&s=1`);
  for(let i=0;i<h.clues.length;i++) await page(`Clue ${i+1}`,`${base}?play=${k}&s=${i+2}`);
  await page("FINISH QR",`${base}?play=${k}&s=${h.clues.length+2}`);
  pdf.save(`${h.name}.pdf`);
}
</script>
</body>
</html>
