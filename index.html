<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scavenger Hunts</title>

<style>
:root{
  --bg:#f4f6f8;
  --card:#ffffff;
  --accent:#2563eb;
  --text:#111827;
}

body{
  margin:0;
  font-family: system-ui, -apple-system, sans-serif;
  background:var(--bg);
  color:var(--text);
}

.theme-blue{ --accent:#2563eb; }
.theme-red{ --accent:#dc2626; }
.theme-green{ --accent:#16a34a; }
.theme-purple{ --accent:#7c3aed; }
.theme-dark{
  --bg:#0f172a;
  --card:#020617;
  --text:#e5e7eb;
  --accent:#38bdf8;
}

.card{
  max-width:900px;
  margin:auto;
  padding:20px;
}

.hunt{
  border:1px solid #ddd;
  padding:12px;
  border-radius:10px;
  margin-bottom:12px;
  background:var(--card);
}

button{
  padding:10px 16px;
  border-radius:10px;
  border:none;
  background:var(--accent);
  color:white;
  font-size:16px;
  cursor:pointer;
}

button.secondary{
  background:#6b7280;
}

textarea,input,select{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  font-size:16px;
}

.center-screen{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  padding:20px;
}

.center-screen h1{
  font-size:2.2rem;
  margin-bottom:16px;
}

.center-screen p{
  font-size:1.5rem;
  max-width:800px;
}

.bottom-bar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  padding:16px;
  background:linear-gradient(transparent,rgba(0,0,0,0.1));
  display:flex;
  justify-content:center;
  gap:12px;
}

video{
  width:100%;
  max-width:420px;
  border-radius:12px;
  margin-top:12px;
}
</style>
</head>

<body>
<div class="card" id="app"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
/* =====================
   UTIL
===================== */
function cleanText(t){
  return t.replace(/[‚Äò‚Äô]/g,"'").replace(/[‚Äú‚Äù]/g,'"');
}
function uid(){ return Math.random().toString(36).slice(2,9); }

/* =====================
   DEFAULT HUNTS
===================== */
const DEFAULT_HUNTS={
  escape:{
    name:"Escape the House",
    theme:"blue",
    intro:"Welcome! Your escape challenge begins now üè†",
    clues:[
      "I show your face but I'm not a photo.",
      "I have pages but no homework.",
      "I keep food safe and cold.",
      "I go round and round but never get dizzy.",
      "I have hands but no arms.",
      "I hide your feet when you're not home.",
      "I'm soft, comfy, and steal naps.",
      "I light the dark when switched on.",
      "I'm full of secrets behind closed doors.",
      "The prize is hidden where valuables stay safe."
    ],
    finish:"üéâ Congratulations! You escaped the house!"
  },
  fortnite:{
    name:"Fortnite IRL",
    theme:"purple",
    intro:"Drop in! Your real-world Fortnite challenge starts now üéÆ",
    clues:[
      "Controllers land here after a match.",
      "Drinks restore shields here.",
      "Shoes hide here after the storm.",
      "Materials are stored with tools.",
      "The squad gathers here.",
      "You can‚Äôt win without sleep.",
      "Secrets behind closed doors.",
      "Devices recharge here.",
      "High ground advantage.",
      "Where battles are watched.",
      "Snacks disappear here.",
      "Victory Royale location."
    ],
    finish:"üèÜ Victory Royale! You completed the hunt!"
  },
  hacker:{
    name:"System Breach",
    theme:"dark",
    intro:"‚ö†Ô∏è Incoming transmission‚Ä¶ system access required.",
    clues:[
      "Device that controls all others.",
      "Passwords written but not digital.",
      "Cold data storage.",
      "Where commands are typed.",
      "Single click changes everything.",
      "Primary power source.",
      "Clothes reset location.",
      "Backup storage area.",
      "Display output surface.",
      "Permission checkpoint.",
      "Hidden encrypted space.",
      "Logs of activity.",
      "User rest zone.",
      "Final access node.",
      "Root access payload location."
    ],
    finish:"‚úÖ SYSTEM BREACH COMPLETE ‚Äî ACCESS GRANTED."
  }
};

let userHunts=JSON.parse(localStorage.getItem("userHunts")||"{}");
let HUNTS={...DEFAULT_HUNTS,...userHunts};
function save(){ localStorage.setItem("userHunts",JSON.stringify(userHunts)); }

/* =====================
   ROUTER
===================== */
const q=new URLSearchParams(location.search);
const app=document.getElementById("app");

if(q.get("play")) play();
else if(q.get("edit")) createHunt(q.get("edit"));
else if(q.get("new")) createHunt();
else home();

/* =====================
   HOME
===================== */
function home(){
  app.className="";
  app.innerHTML=`
    <h1>QR Scavenger Hunts</h1>
    <button onclick="location='?new=1'">‚ûï Create New Hunt</button>
    ${Object.entries(HUNTS)
      .sort((a,b)=>a[1].name.localeCompare(b[1].name))
      .map(([k,h])=>`
        <div class="hunt">
          <h3>${h.name}</h3>
          <button onclick="generatePDF('${k}')">üñ® Generate QR PDF</button>
          ${DEFAULT_HUNTS[k]?"":`<button class="secondary" onclick="location='?edit=${k}'">‚úè Modify</button>`}
        </div>
      `).join("")}
  `;
}

/* =====================
   CREATE / EDIT
===================== */
function createHunt(k){
  const h=k?HUNTS[k]:{
    name:"",
    theme:"blue",
    intro:"",
    clues:[""],
    finish:""
  };

  app.innerHTML=`
    <h2>${k?"Modify":"Create"} Hunt</h2>
    <input id="name" placeholder="Hunt name" value="${h.name}">
    <select id="theme">
      ${["blue","red","green","purple","dark"].map(t=>
        `<option ${h.theme===t?"selected":""} value="${t}">${t}</option>`
      ).join("")}
    </select>
    <textarea id="intro" placeholder="Custom intro message">${h.intro}</textarea>
    <div id="clues"></div>
    <button onclick="addClue()">‚ûï Add Clue</button>
    <textarea id="finish" placeholder="Final congratulations message">${h.finish}</textarea>
    <button onclick="saveHunt('${k||""}')">üíæ Save</button>
    <button class="secondary" onclick="home()">Cancel</button>
  `;

  h.clues.forEach(c=>addClue(c));
}

function addClue(text=""){
  const t=document.createElement("textarea");
  t.placeholder="Clue text";
  t.value=text;
  document.getElementById("clues").appendChild(t);
}

function saveHunt(k){
  const name=nameEl.value.trim();
  const intro=introEl.value.trim();
  const finish=finishEl.value.trim();
  const theme=document.getElementById("theme").value;
  const clues=[...document.querySelectorAll("#clues textarea")].map(t=>t.value).filter(Boolean);
  if(!name||!intro||!finish||!clues.length) return alert("All fields required");
  if(!k) k=uid();
  userHunts[k]={name,theme,intro,clues,finish};
  HUNTS[k]=userHunts[k];
  save();
  home();
}

/* =====================
   PLAY
===================== */
function play(){
  const key=q.get("play");
  const h=HUNTS[key];
  const step=parseInt(q.get("s"));
  document.body.className="theme-"+h.theme;

  const store="p-"+key;
  let p=parseInt(localStorage.getItem(store)||"-1");

  const show=(title,text)=>{
    app.innerHTML=`
      <div class="center-screen">
        <h1>${title}</h1>
        <p>${text}</p>
      </div>
      <div class="bottom-bar">
        <button onclick="startC
