<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scavenger Hunts</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f4f6f8;
  padding: 20px;
}
.card {
  max-width: 900px;
  margin: auto;
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
button { padding: 8px 14px; margin: 6px 6px 6px 0; }
textarea { width: 100%; min-height: 60px; }
input[type="text"] { width: 100%; padding: 8px; margin-bottom: 12px; }
.hunt { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
.success { background:#e7f6e7;padding:12px;border-radius:8px; }
.error { background:#ffe5e5;padding:12px;border-radius:8px; }
</style>
</head>

<body>
<div class="card" id="app"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* =========================
   PDF TEXT SANITISER
========================= */
function cleanText(t){
  return t
    .replace(/[â€˜â€™]/g,"'")
    .replace(/[â€œâ€]/g,'"')
    .replace(/â€“/g,"-")
    .replace(/â€¦/g,"...");
}

/* =========================
   FULL STARTER HUNTS
========================= */
const DEFAULT_HUNTS = {
  escape: {
    name: "Escape the House (Age 11)",
    clues: [
      "I show your face but Iâ€™m not a photo.",
      "I have pages but no homework.",
      "I keep food safe and cold.",
      "I go round and round but never get dizzy.",
      "I have hands but no arms.",
      "I hide your feet when youâ€™re not home.",
      "Iâ€™m soft, comfy, and steal naps.",
      "I light the dark when switched on.",
      "Iâ€™m full of secrets behind closed doors.",
      "The prize is hidden where valuables stay safe."
    ]
  },
  fortnite: {
    name: "Fortnite IRL â€“ Victory Royale (Age 13)",
    clues: [
      "Controllers land here after a match.",
      "Drinks restore shields here.",
      "Shoes hide here after the storm.",
      "Materials are stored with tools.",
      "The squad gathers here.",
      "You canâ€™t win without sleep.",
      "Secrets behind closed doors.",
      "Devices recharge here.",
      "High ground advantage.",
      "Where battles are watched.",
      "Snacks disappear here.",
      "ðŸ† Victory Royale location."
    ]
  },
  hacker: {
    name: "System Breach (Age 19)",
    clues: [
      "Device that controls all others.",
      "Passwords written but not digital.",
      "Cold data storage.",
      "Where commands are typed.",
      "Single click changes everything.",
      "Primary power source.",
      "Clothes reset location.",
      "Backup storage area.",
      "Display output surface.",
      "Permission checkpoint.",
      "Hidden encrypted space.",
      "Logs of activity.",
      "User rest zone.",
      "Final access node.",
      "Root access payload location."
    ]
  }
};

/* =========================
   STORAGE
========================= */
const userHunts = JSON.parse(localStorage.getItem("userHunts")) || {};
const HUNTS = { ...DEFAULT_HUNTS, ...userHunts };

function saveUserHunts(){
  const out = {};
  Object.keys(HUNTS).forEach(k=>{
    if(!DEFAULT_HUNTS[k]) out[k] = HUNTS[k];
  });
  localStorage.setItem("userHunts", JSON.stringify(out));
}

/* =========================
   ROUTER
========================= */
const params = new URLSearchParams(location.search);
const app = document.getElementById("app");
const huntKey = params.get("h");
const step = parseInt(params.get("s"),10);

if(huntKey && !isNaN(step)) runHunt();
else runHome();

/* =========================
   HOME (ADULT / SETUP)
========================= */
function runHome(){
  app.innerHTML = `
    <h1>QR Scavenger Hunts</h1>
    <p><strong>Adults:</strong> Click Start to generate QR codes.<br>
    <strong>Players:</strong> Scan the START QR.</p>

    ${Object.entries(HUNTS)
      .sort((a,b)=>a[1].name.localeCompare(b[1].name))
      .map(([k,h])=>`
        <div class="hunt">
          <h2>${h.name}</h2>
          <button onclick="generatePDF('${k}',HUNTS['${k}'])">
            ðŸ–¨ Start / Generate QR Pack
          </button>
        </div>
      `).join("")}
  `;
}

/* =========================
   PLAYER MODE
========================= */
function runHunt(){
  const h = HUNTS[huntKey];
  if(!h) return app.innerHTML="<div class='error'>Invalid hunt</div>";

  const key="progress-"+huntKey;
  let c=parseInt(localStorage.getItem(key),10);
  if(isNaN(c)) c=-1;

  if(step===0 && c===-1){
    localStorage.setItem(key,0);
    return app.innerHTML=`<h1>${h.name}</h1><p>${h.clues[0]}</p>`;
  }

  if(step===c+1){
    localStorage.setItem(key,step);
    return app.innerHTML=`<h1>${h.name}</h1><p>${h.clues[step]}</p>`;
  }

  app.innerHTML="<div class='error'>Wrong QR code. Try again.</div>";
}

/* =========================
   PDF GENERATOR (FIXED)
========================= */
async function generatePDF(key,h){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const base = location.origin + location.pathname;

  pdf.setFontSize(18);
  pdf.text(cleanText(h.name),10,20);

  pdf.setFontSize(12);
  pdf.text(cleanText(
`HOW TO PLAY

1. Print this PDF
2. Place the START QR where players begin
3. Hide each next QR at the answer to the clue
4. Players must scan in order`
  ),10,35);

  async function page(title,url){
    pdf.addPage();
    pdf.text(cleanText(title),10,20);
    const canvas=document.createElement("canvas");
    await QRCode.toCanvas(canvas,url,{width:300});
    pdf.addImage(canvas.toDataURL(),"PNG",30,40,150,150);
  }

  await page("START QR",`${base}?h=${key}&s=0`);
  for(let i=0;i<h.clues.length;i++){
    await page(`Clue ${i+1}`,`${base}?h=${key}&s=${i+1}`);
  }

  pdf.addPage();
  pdf.text("Printable Clues",10,20);
  let y=30;
  h.clues.forEach((c,i)=>{
    pdf.text(`Clue ${i+1}: ${cleanText(c)}`,10,y);
    y+=12;
  });

  pdf.output("dataurlnewwindow");
}
</script>
</body>
</html>

